set shell := [ "bash", "-c" ]

default:
	@just test

build-test:
	@just build alloc_test \
		generic/abort.ll \
		generic/alloc.ll \
		linux-x86_64/sys.ll \
		linux-x86_64/thread.ll \
		test/alloc_test.ll

build output +sources:
	llvm-link-17 -S -o tmp/{{file_stem(output)}}.ll {{sources}}
	llc-17 -O=3 -filetype=obj -o tmp/{{file_stem(output)}}.o tmp/{{file_stem(output)}}.ll
	ld.lld-17 -o bin/{{output}} tmp/{{file_stem(output)}}.o

test:
	@just build-test
	bin/alloc_test

clean:
	rm -f bin/* tmp/*

strace:
	@just build-test
	strace -x bin/alloc_test >/dev/null

time:
	@just build-test
	time bin/alloc_test
