set shell := [ "bash", "-c" ]

default:
	@just test

alloc_test:
	@just build alloc_test \
		generic/abort.ll \
		generic/alloc.ll \
		linux-x86_64/sys.ll \
		linux-x86_64/thread.ll \
		test/alloc_test.ll
	
	bin/alloc_test

data_test:
	@just build data_test \
		generic/abort.ll \
		generic/alloc.ll \
		generic/data.ll \
		generic/ref.ll \
		linux-x86_64/sys.ll \
		linux-x86_64/thread.ll \
		test/data_test.ll
	
	bin/data_test

ref_test:
	@just build ref_test \
		generic/abort.ll \
		generic/alloc.ll \
		generic/ref.ll \
		linux-x86_64/sys.ll \
		linux-x86_64/thread.ll \
		test/ref_test.ll

	bin/ref_test

task_test:
	@just build task_test \
		generic/abort.ll \
		generic/alloc.ll \
		generic/task.ll \
		linux-x86_64/sys.ll \
		linux-x86_64/thread.ll \
		test/task_test.ll

	bin/task_test

build output +sources:
	llvm-link-17 -S -o tmp/{{file_stem(output)}}.ll {{sources}}
	llc-17 -O=3 -filetype=obj -o tmp/{{file_stem(output)}}.o tmp/{{file_stem(output)}}.ll
	ld.lld-17 -o bin/{{output}} tmp/{{file_stem(output)}}.o

test:
	@just alloc_test
	@just data_test
	@just ref_test
	@just task_test

clean:
	rm -f bin/* tmp/*
